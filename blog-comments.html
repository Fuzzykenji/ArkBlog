<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE-Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="CSS/blog-style.css" />
  <link rel="stylesheet" href="https://cdn.lineicons.com/4.0/lineicons.css" />
  <title>Blog Post | ARK</title>
  <style>
    .container { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    .post-img { width:100%; max-height:400px; object-fit:cover; border-radius:8px; }
    .post-meta { color:#666; margin-bottom: 8px; }
    .back-btn { display:inline-block; margin-bottom:16px; text-decoration:none; }
    #giscus-wrapper { margin-top:40px; border-top:1px solid #eee; padding-top:24px; }
    h2.post-title { margin-bottom: 8px; }
    .btn { display: inline-block; padding: 10px 18px; background: linear-gradient(45deg,#ff6b6b,#f06d06); color: #fff; border-radius: 22px; text-decoration:none; font-weight:bold; }
  </style>
</head>
<body>
  <header class="header">
    <nav class="nav container padd-15">
      <a href="index.html" class="nav-logo"><h2>Ark</h2></a>
    </nav>
  </header>

  <main class="container">
    <a href="index.html" class="back-btn btn">← Back to Blog</a>

    <article id="post">
      <!-- Filled by JS -->
    </article>

    <!-- ARK Comments (Giscus) -->
    <section id="giscus-wrapper" aria-labelledby="giscus-heading">
      <h3 id="giscus-heading">ARK Comments</h3>
      <div id="giscus-comments"></div>
    </section>
  </main>

  <script>
    // Utility: get query param 'index'
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.has(name) ? params.get(name) : null;
    }

    // Load blog from localStorage and render
    const blogs = JSON.parse(localStorage.getItem('blogs')) || [];
    const index = parseInt(getQueryParam('index'), 10);
    const postEl = document.getElementById('post');

    if (!Number.isInteger(index) || index < 0 || index >= blogs.length) {
      postEl.innerHTML = '<p>Blog post not found. Go back to the <a href="index.html">blog list</a>.</p>';
    } else {
      const blog = blogs[index];

      function getImageSrc(image) {
        if (!image) return '';
        if (image.startsWith('data:image/')) return image;
        return '/uploads/' + image;
      }

      const imageHtml = getImageSrc(blog.image)
        ? `<img src="${getImageSrc(blog.image)}" alt="${escapeHtml(blog.title)}" class="post-img" />`
        : '';

      postEl.innerHTML = `
        ${imageHtml}
        <h2 class="post-title">${escapeHtml(blog.title)}</h2>
        <p class="post-meta"><strong>By:</strong> ${escapeHtml(blog.author)} • <em>${escapeHtml(blog.date || '')}</em></p>
        <div class="post-content">${nl2br(escapeHtml(blog.content || ''))}</div>
      `;

      const identifier = makeIdentifier(index, blog.title);
      loadGiscus(identifier);
    }

    // ---- Helpers ----
    function makeIdentifier(idx, title) {
      const slug = (title || 'post').toString().toLowerCase()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'')
        .substring(0, 60);
      return `ARK-post-${idx}-${slug}`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function nl2br(text) {
      return text.replace(/\n/g, '<br>');
    }

    // ---- GISCUS loader (with your actual config) ----
    function loadGiscus(term) {
      const container = document.getElementById('giscus-comments');
      container.innerHTML = '';

      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.async = true;
      script.crossOrigin = 'anonymous';

      // Your actual configuration from giscus.app
      script.setAttribute('data-repo', 'Fuzzykenji/ArkBlog');
      script.setAttribute('data-repo-id', 'R_kgDOOiXEtw');
      script.setAttribute('data-category', 'Announcements');
      script.setAttribute('data-category-id', 'DIC_kwDOOiXEt84Cxw6U');
      script.setAttribute('data-mapping', 'specific');
      script.setAttribute('data-term', term);
      script.setAttribute('data-strict', '0');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-input-position', 'bottom');
      script.setAttribute('data-theme', 'preferred_color_scheme');
      script.setAttribute('data-lang', 'en');

      container.appendChild(script);

      const label = document.createElement('p');
      label.style.fontSize = '12px';
      label.style.color = '#666';
      label.style.marginTop = '8px';
      label.innerText = `Discussion thread: ${term}`;
      container.appendChild(label);
    }
  </script>
</body>
</html>
